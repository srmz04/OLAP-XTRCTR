name: OLAP Live Test

on:
  workflow_dispatch:
    inputs:
      catalog:
        description: 'Catalog to test'
        required: false
        default: 'SIS_2025'
      mode:
        description: 'Execution Mode'
        required: true
        default: 'scan'
        type: choice
        options:
        - test
        - scan

jobs:
  run_olap_task:
    name: Run OLAP Task on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python 3.10
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'

    - name: Cache OLEDB Installer
      id: cache-oledb
      uses: actions/cache@v3
      with:
        path: oledb.msi
        key: oledb-installer-v1

    - name: Download OLEDB Provider
      if: steps.cache-oledb.outputs.cache-hit != 'true'
      shell: powershell
      run: |
        $url = "https://go.microsoft.com/fwlink/?linkid=829576"
        Invoke-WebRequest -Uri $url -OutFile "oledb.msi"

    - name: Install MSOLAP OLEDB Driver
      shell: powershell
      run: |
        Start-Process msiexec.exe -ArgumentList '/i', 'oledb.msi', '/quiet', '/norestart' -NoNewWindow -Wait

    - name: Install Core Dependencies
      shell: powershell
      run: |
        # CRITICAL: Downgrade setuptools to support 2to3 for adodbapi (EXACT as working scanner)
        python -m pip install --upgrade pip
        pip install "setuptools==57.5.0" wheel

    - name: Install adodbapi from Source
      shell: powershell
      run: |
        $url = "https://files.pythonhosted.org/packages/source/a/adodbapi/adodbapi-2.6.2.0.zip"
        Invoke-WebRequest -Uri $url -OutFile "adodbapi.zip"
        Expand-Archive -Path "adodbapi.zip" -DestinationPath "adodb_src" -Force
        cd adodb_src\adodbapi-2.6.2.0
        python setup.py install

    - name: Install Project Dependencies
      run: |
        # EXACT LIST from working config (added pywin32)
        pip install pandas>=1.5.0 openpyxl>=3.1.0 colorama>=0.4.6 tqdm>=4.65.0 rich>=13.0.0 pywin32>=306

    - name: Execute OLAP Action
      env:
        DGIS_SERVER: ${{ secrets.DGIS_SERVER }}
        DGIS_USER: ${{ secrets.DGIS_USER }}
        DGIS_PASSWORD: ${{ secrets.DGIS_PASSWORD }}
        PYTHONPATH: ${{ github.workspace }}/backend
      run: |
        python backend/run_action.py "${{ inputs.mode }}" "${{ inputs.catalog }}"

    - name: List Generated Files (Debug)
      if: always()
      run: dir

    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: olap-results-${{ inputs.catalog }}
        path: "*.csv"
        if-no-files-found: warn
