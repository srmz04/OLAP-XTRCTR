name: OLAP Live Test

on:
  workflow_dispatch:
    inputs:
      catalog:
        description: 'Catalog to test'
        required: false
        default: 'SIS_2025'
      mode:
        description: 'Execution Mode'
        required: true
        default: 'scan'
        type: choice
        options:
        - test
        - scan

jobs:
  run_olap_task:
    name: Run OLAP Task on Windows
    runs-on: windows-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install Dependencies
      run: |
        pip install pandas adodbapi openpyxl colorama tqdm rich

    - name: Install MSOLAP OLEDB Driver
      shell: powershell
      run: |
        Write-Host "Downloading SQL AS OLEDB..."
        $url = "https://download.microsoft.com/download/4/D/D/4DD7C69E-52F6-44C0-8356-347D34B21F7A/SQL_AS_OLEDB.msi"
        $out = "oledb.msi"
        Invoke-WebRequest -Uri $url -OutFile $out
        
        Write-Host "Installing MSI..."
        Start-Process msiexec.exe -ArgumentList '/i', $out, '/quiet', '/norestart' -NoNewWindow -Wait
        
        Write-Host "Verification (optional)..."
        # Can't easily verify registry in restricted shell, but if msiexec passed, we assume success.

    - name: Execute OLAP Action
      env:
        DGIS_SERVER: ${{ secrets.DGIS_SERVER }}
        DGIS_USER: ${{ secrets.DGIS_USER }}
        DGIS_PASSWORD: ${{ secrets.DGIS_PASSWORD }}
        PYTHONPATH: ${{ github.workspace }}/backend
      run: |
        # Run the robust wrapper script
        python backend/run_action.py "${{ inputs.mode }}" "${{ inputs.catalog }}"

    - name: List Generated Files (Debug)
      if: always()
      run: dir

    - name: Upload Results
      uses: actions/upload-artifact@v4
      with:
        name: olap-results-${{ inputs.catalog }}
        path: "*.csv"
        if-no-files-found: warn
