name: OLAP Scanner

on:
  workflow_dispatch:
    inputs:
      catalog:
        description: 'Catalog to scan (e.g., sis2011, SIS_2025)'
        required: false
        default: ''
      mode:
        description: 'Scan mode: discover, explore, or data'
        required: true
        default: 'discover'
        type: choice
        options:
          - discover
          - explore
          - data

jobs:
  scan:
    runs-on: windows-latest
    
    env:
      DGIS_SERVER: ${{ secrets.DGIS_SERVER }}
      DGIS_USER: ${{ secrets.DGIS_USER }}
      DGIS_PASSWORD: ${{ secrets.DGIS_PASSWORD }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Download OLEDB Provider
        shell: powershell
        run: |
          $url = "https://go.microsoft.com/fwlink/?linkid=829576"
          $output = "SQL_AS_OLEDB.msi"
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Host "Downloaded OLEDB Provider"
      
      - name: Install OLEDB Provider
        shell: powershell
        run: |
          Start-Process msiexec.exe -ArgumentList '/i', 'SQL_AS_OLEDB.msi', '/quiet', '/norestart' -Wait
          Write-Host "Installed OLEDB Provider"
      
      - name: Install Python dependencies
        shell: powershell
        run: |
          # Upgrade pip and install base tools with OLD setuptools (has build_py_2to3)
          pip install --upgrade pip
          pip install "setuptools==57.5.0" wheel
          
          # Download adodbapi source directly from PyPI (not via pip)
          $url = "https://files.pythonhosted.org/packages/source/a/adodbapi/adodbapi-2.6.2.0.zip"
          Invoke-WebRequest -Uri $url -OutFile "adodbapi.zip"
          
          # Extract and install using legacy setup.py
          Expand-Archive -Path "adodbapi.zip" -DestinationPath "adodb_src" -Force
          cd adodb_src\adodbapi-2.6.2.0
          python setup.py install
          cd ..\..
          
          # Install remaining dependencies
          pip install pandas>=1.5.0 openpyxl>=3.1.0 colorama>=0.4.6 tqdm>=4.65.0 rich>=13.0.0 pywin32>=306
      
      - name: Run OLAP Scanner
        shell: powershell
        run: |
          cd scanner
          python DGIS_SCAN_2_stable.py --mode ${{ github.event.inputs.mode }}
      
      - name: Upload scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: olap-scan-results
          path: |
            scanner/olap_discovery/
            scanner/*.csv
            scanner/*.xlsx
          retention-days: 30
