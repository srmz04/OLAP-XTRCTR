name: OLAP Query Relay

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - get_catalogs
          - discover_structure
          - discover_metadata
          - diagnose_schema
          - get_apartados
          - execute_query
          - execute_mdx
      catalog:
        description: 'Catalog name (e.g., SIS_2025)'
        required: false
        default: ''
      params:
        description: 'JSON params for the action'
        required: false
        default: '{}'
      request_id:
        description: 'Unique request ID for result tracking'
        required: true

jobs:
  query:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Cache OLEDB Installer
        id: cache-oledb
        uses: actions/cache@v4
        with:
          path: SQL_AS_OLEDB.msi
          key: oledb-installer-v1

      - name: Download OLEDB Provider
        if: steps.cache-oledb.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $url = "https://go.microsoft.com/fwlink/?linkid=829576"
          $output = "SQL_AS_OLEDB.msi"
          Invoke-WebRequest -Uri $url -OutFile $output
          Write-Host "Downloaded OLEDB Provider"

      - name: Install OLEDB Provider
        shell: powershell
        run: |
          Start-Process msiexec.exe -ArgumentList '/i', 'SQL_AS_OLEDB.msi', '/quiet', '/norestart' -Wait
          Write-Host "Installed OLEDB Provider"

      - name: Install Python dependencies
        shell: powershell
        run: |
          pip install --upgrade pip
          pip install "setuptools==57.5.0" wheel
          
          # Download adodbapi from PyPI
          $url = "https://files.pythonhosted.org/packages/source/a/adodbapi/adodbapi-2.6.2.0.zip"
          Invoke-WebRequest -Uri $url -OutFile "adodbapi.zip"
          
          # Extract and install
          Expand-Archive -Path "adodbapi.zip" -DestinationPath "adodb_src" -Force
          cd adodb_src\adodbapi-2.6.2.0
          python setup.py install
          cd ..\..
          
          # Install remaining dependencies
          pip install pandas pywin32

      - name: Execute Query
        id: query
        env:
          DGIS_SERVER: ${{ secrets.DGIS_SERVER }}
          DGIS_USER: ${{ secrets.DGIS_USER }}
          DGIS_PASSWORD: ${{ secrets.DGIS_PASSWORD }}
          ACTION: ${{ inputs.action }}
          CATALOG: ${{ inputs.catalog }}
          PARAMS: ${{ inputs.params }}
          REQUEST_ID: ${{ inputs.request_id }}
        run: python backend/actions_runner.py

      - name: Upload result to Gist
        uses: actions/github-script@v7
        env:
          RESULT_FILE: result.json
          REQUEST_ID: ${{ inputs.request_id }}
        with:
          github-token: ${{ secrets.GIST_TOKEN }}
          script: |
            const fs = require('fs');
            const result = fs.readFileSync('result.json', 'utf8');
            const gistId = '${{ secrets.GIST_ID }}';
            
            await github.rest.gists.update({
              gist_id: gistId,
              files: {
                [`${process.env.REQUEST_ID}.json`]: {
                  content: result
                }
              }
            });
            console.log(`Result uploaded to gist for request ${process.env.REQUEST_ID}`);
